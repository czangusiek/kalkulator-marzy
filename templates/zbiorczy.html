<!DOCTYPE html>
<html lang="pl" class="{{ 'dark-mode' if session.get('dark_mode') else '' }}">
<head>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator mar≈ºy zbiorczej</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --table-header-bg: #f2f2f2;
            --table-border: #ddd;
            --container-bg: #f9f9f9;
            --container-border: #ccc;
            --hr-color: #ccc;
            --red-color: #ff0000;
            --green-color: #008000;
            --blue-color: #0000ff;
            --orange-color: #ffa500;
        }

        .dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --table-header-bg: #1e1e1e;
            --table-border: #444;
            --container-bg: #1a1a1a;
            --container-border: #555;
            --hr-color: #555;
            --red-color: #ff6b6b;
            --green-color: #6bff6b;
            --blue-color: #6b6bff;
            --orange-color: #ffb74d;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .nawigacja {
            margin-bottom: 20px;
            padding: 10px;
            border-bottom: 1px solid var(--container-border);
        }

        .nawigacja a {
            margin-right: 15px;
            text-decoration: none;
            color: var(--blue-color);
            font-weight: bold;
        }

        .nawigacja a.aktywny {
            color: var(--green-color);
            text-decoration: underline;
        }

        .kalkulator {
            padding: 20px;
            border: 1px solid var(--container-border);
            border-radius: 5px;
            background-color: var(--container-bg);
            margin-bottom: 20px;
        }

        input[type="file"] {
            padding: 10px;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--table-border);
            border-radius: 4px;
        }

        input[type="submit"] {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 16px;
        }

        input[type="submit"]:hover {
            background-color: #45a049;
        }

        select, input[type="text"] {
            padding: 8px;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--table-border);
            border-radius: 4px;
        }

        input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .wynik {
            font-size: 16px;
            line-height: 1.6;
        }
        .wynik table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .wynik th, .wynik td {
            border: 1px solid var(--table-border);
            padding: 8px;
            text-align: left;
        }
        .wynik th {
            background-color: var(--table-header-bg);
        }

        .podsumowanie {
            background-color: var(--table-header-bg);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .stat-box {
            display: inline-block;
            padding: 10px 20px;
            margin: 0 10px;
            background-color: var(--container-bg);
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--green-color);
        }

        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            color: var(--text-color);
        }

        .przyklad-csv {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--table-header-bg);
            border-radius: 4px;
            font-size: 14px;
        }

        .error-message {
            color: var(--red-color);
            background-color: rgba(255, 0, 0, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid var(--red-color);
        }

        .success-message {
            color: var(--green-color);
            background-color: rgba(0, 255, 0, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid var(--green-color);
        }

        .kwota-do-kopiowania {
            cursor: pointer;
            transition: all 0.2s;
            padding: 2px 5px;
            border-radius: 3px;
            display: inline-block;
        }
        .kwota-do-kopiowania:hover {
            background-color: var(--table-header-bg);
            box-shadow: 0 0 0 1px var(--table-border);
        }
        .kwota-do-kopiowania:active {
            transform: scale(0.98);
        }
        .skopiowano-info {
            color: var(--green-color);
            font-size: 0.8em;
            margin-left: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <button class="dark-mode-toggle" onclick="toggleDarkMode()">
        {{ 'üåû' if session.get('dark_mode') else 'üåì' }}
    </button>

    <h1>Kalkulator mar≈ºy zbiorczej</h1>
    <div class="nawigacja">
        <a href="/">Kalkulator</a> | 
        <a href="/licznik">Licznik</a> | 
        <a href="/porownaj">Por√≥wnywarka</a> |
        <a href="/zbiorczy" class="aktywny">Mar≈ºa zbiorcza</a>
    </div>
    
    <div class="kalkulator">
        <h2>Oblicz mar≈ºe dla wielu produkt√≥w</h2>
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <label for="plik_csv">Prze≈õlij plik CSV:</label>
            <input type="file" id="plik_csv" name="plik_csv" accept=".csv,.txt">
            
            <div class="przyklad-csv">
                <strong>Wymagany format pliku CSV:</strong><br>
                LP;NAZWA;CENA_NETTO;CENA_BRUTTO<br>
                1;Produkt A;10.00;15.00<br>
                2;Produkt B;20.00;30.00<br>
                3;Produkt C;5.00;8.50<br>
                <br>
                <strong>Uwagi:</strong>
                <ul>
                    <li>Mo≈ºesz u≈ºyƒá ≈õrednika (;) lub przecinka (,) jako separatora</li>
                    <li>Wymagane kolumny: NAZWA oraz przynajmniej jedna z cen (NETTO lub BRUTTO)</li>
                    <li>Je≈õli brakuje jednej z cen, zostanie obliczona automatycznie (VAT 23%)</li>
                    <li>Mo≈ºesz wyeksportowaƒá dane z Excela jako CSV</li>
                    <li>Obs≈Çugiwane encodingi: UTF-8, Windows-1250, ISO-8859-2</li>
                </ul>
            </div>
            
            <label for="kategoria_zbiorcza">Kategoria:</label>
            <select id="kategoria_zbiorcza" name="kategoria_zbiorcza">
                <option value="A">Supermarket (6,15%)</option>
                <option value="B">Cukier (12,92%)</option>
                <option value="C">Chemia gospodarcza (12,92%)</option>
                <option value="D">AGD zwyk≈Çe (13,53%)</option>
                <option value="E">Elektronika (5,55%)</option>
                <option value="F">Chemia do 60 z≈Ç (18,45% / 9,84%)</option>
                <option value="G">Sklep internetowy</option>
                <option value="H">Inna prowizja</option>
                <option value="I">Strefa okazji (+60% prowizji podstawowej)</option>
            </select>
            
            <label>
                <input type="checkbox" id="czy_smart_zbiorcze" name="czy_smart_zbiorcze" checked>
                Czy smart?
            </label>
            
            <label for="koszt_pakowania_zbiorcze">Koszt pakowania na sztukƒô (z≈Ç):</label>
            <input type="text" id="koszt_pakowania_zbiorcze" name="koszt_pakowania_zbiorcze" value="0">
            
            <br>
            <input type="submit" name="submit_zbiorczy" value="Oblicz mar≈ºe zbiorczo">
        </form>

        {% if error_message %}
        <div class="error-message">
            <strong>B≈ÇƒÖd:</strong> {{ error_message }}
        </div>
        {% endif %}
    </div>

    {% if wyniki_zbiorcze %}
    <div class="podsumowanie">
        <h3>Podsumowanie zbiorcze</h3>
        <div class="stat-box">
            <div>≈ÅƒÖczna mar≈ºa</div>
            <div class="stat-value">{{ "%.2f"|format(laczna_marza) }} z≈Ç</div>
        </div>
        <div class="stat-box">
            <div>≈örednia mar≈ºa/szt</div>
            <div class="stat-value">{{ "%.2f"|format(laczna_marza/liczba_produktow if liczba_produktow > 0 else 0) }} z≈Ç</div>
        </div>
        <div class="stat-box">
            <div>≈ÅƒÖczny zakup</div>
            <div class="stat-value">{{ "%.2f"|format(laczna_cena_zakupu) }} z≈Ç</div>
        </div>
        <div class="stat-box">
            <div>≈ÅƒÖczna sprzeda≈º</div>
            <div class="stat-value">{{ "%.2f"|format(laczna_cena_sprzedazy) }} z≈Ç</div>
        </div>
        <div class="stat-box">
            <div>Liczba produkt√≥w</div>
            <div class="stat-value">{{ liczba_produktow }}</div>
        </div>
    </div>

    <div class="wynik">
        <h3>Szczeg√≥≈Çowe wyniki</h3>
        <table>
            <thead>
                <tr>
                    <th>LP</th>
                    <th>Nazwa produktu</th>
                    <th>Cena zakupu</th>
                    <th>Cena sprzeda≈ºy</th>
                    <th>Prowizja</th>
                    <th>Dostawa</th>
                    <th>Pakowanie</th>
                    <th>Mar≈ºa netto</th>
                    <th>Mar≈ºa %</th>
                </tr>
            </thead>
            <tbody>
                {% for wynik in wyniki_zbiorcze %}
                <tr>
                    <td>{{ wynik.lp if wynik.lp else loop.index }}</td>
                    <td>{{ wynik.nazwa }}</td>
                    <td>
                        <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                              data-value="{{ "%.2f"|format(wynik.cena_zakupu) }}">
                            {{ "%.2f"|format(wynik.cena_zakupu) }} z≈Ç
                        </span>
                    </td>
                    <td>
                        <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                              data-value="{{ "%.2f"|format(wynik.cena_sprzedazy) }}">
                            {{ "%.2f"|format(wynik.cena_sprzedazy) }} z≈Ç
                        </span>
                    </td>
                    <td>
                        <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                              data-value="{{ "%.2f"|format(wynik.prowizja) }}" style="color:var(--red-color);">
                            {{ "%.2f"|format(wynik.prowizja) }} z≈Ç
                        </span>
                    </td>
                    <td>
                        <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                              data-value="{{ "%.2f"|format(wynik.dostawa) }}" style="color:var(--red-color);">
                            {{ "%.2f"|format(wynik.dostawa) }} z≈Ç
                        </span>
                    </td>
                    <td>
                        <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                              data-value="{{ "%.2f"|format(wynik.koszt_pakowania) }}" style="color:var(--red-color);">
                            {{ "%.2f"|format(wynik.koszt_pakowania) }} z≈Ç
                        </span>
                    </td>
                    <td>
                        <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                              data-value="{{ "%.2f"|format(wynik.marza_netto) }}" style="color:var(--green-color);">
                            {{ "%.2f"|format(wynik.marza_netto) }} z≈Ç
                        </span>
                    </td>
                    <td>
                        <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                              data-value="{{ "%.1f"|format(wynik.marza_procent) }}" style="color:var(--blue-color);">
                            {{ "%.1f"|format(wynik.marza_procent) }}%
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <script>
        function toggleDarkMode() {
            fetch('/toggle_dark_mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.body.classList.toggle('dark-mode', data.dark_mode);
                    document.querySelector('.dark-mode-toggle').textContent = data.icon;
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function kopiujDoSchowka(element) {
            const wartosc = element.getAttribute('data-value');
            const potwierdzenie = document.createElement('span');
            potwierdzenie.className = 'skopiowano-info';
            potwierdzenie.textContent = '‚úì';
            element.appendChild(potwierdzenie);
            potwierdzenie.style.display = 'inline';
            
            setTimeout(() => {
                potwierdzenie.style.display = 'none';
            }, 2000);

            if (navigator.clipboard) {
                navigator.clipboard.writeText(wartosc).catch(() => {
                    kopiujFallback(wartosc);
                });
            } else {
                kopiujFallback(wartosc);
            }
        }

        function kopiujFallback(wartosc) {
            const textarea = document.createElement('textarea');
            textarea.value = wartosc;
            textarea.style.position = 'fixed';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
    </script>
</body>
</html>