<!DOCTYPE html>
<html lang="pl" class="{{ 'dark-mode' if session.get('dark_mode') else '' }}">
<head>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator mar≈ºy zbiorczej</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --table-header-bg: #f2f2f2;
            --table-border: #ddd;
            --container-bg: #f9f9f9;
            --container-border: #ccc;
            --hr-color: #ccc;
            --red-color: #ff0000;
            --green-color: #008000;
            --blue-color: #0000ff;
            --orange-color: #ffa500;
        }

        .dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --table-header-bg: #1e1e1e;
            --table-border: #444;
            --container-bg: #1a1a1a;
            --container-border: #555;
            --hr-color: #555;
            --red-color: #ff6b6b;
            --green-color: #6bff6b;
            --blue-color: #6b6bff;
            --orange-color: #ffb74d;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .nawigacja {
            margin-bottom: 20px;
            padding: 10px;
            border-bottom: 1px solid var(--container-border);
        }

        .nawigacja a {
            margin-right: 15px;
            text-decoration: none;
            color: var(--blue-color);
            font-weight: bold;
        }

        .nawigacja a.aktywny {
            color: var(--green-color);
            text-decoration: underline;
        }

        .kalkulator {
            padding: 20px;
            border: 1px solid var(--container-border);
            border-radius: 5px;
            background-color: var(--container-bg);
            margin-bottom: 20px;
        }

        input[type="file"] {
            padding: 10px;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--table-border);
            border-radius: 4px;
        }

        input[type="submit"] {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 16px;
        }

        input[type="submit"]:hover {
            background-color: #45a049;
        }

        select, input[type="text"] {
            padding: 8px;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--table-border);
            border-radius: 4px;
        }

        input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .wynik {
            font-size: 16px;
            line-height: 1.6;
        }
        .wynik table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .wynik th, .wynik td {
            border: 1px solid var(--table-border);
            padding: 8px;
            text-align: center;
        }
        .wynik th {
            background-color: var(--table-header-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .podsumowanie {
            background-color: var(--table-header-bg);
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 15px;
        }

        .stat-box {
            padding: 15px 25px;
            background-color: var(--container-bg);
            border-radius: 5px;
            text-align: center;
            min-width: 200px;
            flex: 1;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--green-color);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            color: var(--text-color);
        }

        .przyklad-csv {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--table-header-bg);
            border-radius: 4px;
            font-size: 14px;
        }

        .error-message {
            color: var(--red-color);
            background-color: rgba(255, 0, 0, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid var(--red-color);
        }

        .success-message {
            color: var(--green-color);
            background-color: rgba(0, 255, 0, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid var(--green-color);
        }

        .kwota-do-kopiowania {
            cursor: pointer;
            transition: all 0.2s;
            padding: 2px 5px;
            border-radius: 3px;
            display: inline-block;
        }
        .kwota-do-kopiowania:hover {
            background-color: var(--table-header-bg);
            box-shadow: 0 0 0 1px var(--table-border);
        }
        .kwota-do-kopiowania:active {
            transform: scale(0.98);
        }
        .skopiowano-info {
            color: var(--green-color);
            font-size: 0.8em;
            margin-left: 5px;
            display: none;
        }

        .tabela-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--table-border);
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .parametry-obliczen {
            background-color: var(--table-header-bg);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .parametry-obliczen h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--blue-color);
        }

        @media (max-width: 768px) {
            .tabela-container {
                max-height: 400px;
            }
            
            .stat-box {
                min-width: 150px;
                padding: 10px 15px;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            .wynik th, .wynik td {
                padding: 4px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <button class="dark-mode-toggle" onclick="toggleDarkMode()">
        {{ 'üåû' if session.get('dark_mode') else 'üåì' }}
    </button>

    <h1>Kalkulator mar≈ºy zbiorczej</h1>
    <div class="nawigacja">
        <a href="/">Kalkulator</a> | 
        <a href="/licznik">Licznik</a> | 
        <a href="/porownaj">Por√≥wnywarka</a> |
        <a href="/zbiorczy" class="aktywny">Mar≈ºa zbiorcza</a>
    </div>
    
    <div class="kalkulator">
        <h2>Oblicz mar≈ºe dla wielu produkt√≥w</h2>
        <form method="POST" enctype="multipart/form-data">
            <!-- Dodano prosty hidden field dla identyfikacji -->
            <input type="hidden" name="form_type" value="zbiorczy">
            
            <label for="plik_csv">Prze≈õlij plik CSV:</label>
            <input type="file" id="plik_csv" name="plik_csv" accept=".csv,.txt" required>
            
            <div class="przyklad-csv">
                <strong>Wymagany format pliku CSV:</strong><br>
                LP;NAZWA;CENA_NETTO;CENA_BRUTTO<br>
                1;Produkt A;10.00;15.00<br>
                2;Produkt B;20.00;30.00<br>
                3;Produkt C;5.00;8.50<br>
                <br>
                <strong>Uwagi:</strong>
                <ul>
                    <li>Mo≈ºesz u≈ºyƒá ≈õrednika (;) lub przecinka (,) jako separatora</li>
                    <li>Wymagane kolumny: NAZWA oraz przynajmniej jedna z cen (NETTO lub BRUTTO)</li>
                    <li>Je≈õli brakuje jednej z cen, zostanie obliczona automatycznie (VAT 23%)</li>
                    <li>Mo≈ºesz wyeksportowaƒá dane z Excela jako CSV</li>
                    <li>Obs≈Çugiwane encodingi: UTF-8, Windows-1250, ISO-8859-2</li>
                </ul>
            </div>
            
            <label for="kategoria_zbiorcza">Kategoria:</label>
            <select id="kategoria_zbiorcza" name="kategoria_zbiorcza">
                <option value="A" {% if kategoria_zbiorcza == 'A' %}selected{% endif %}>Supermarket (6,15%)</option>
                <option value="B" {% if kategoria_zbiorcza == 'B' %}selected{% endif %}>Cukier (12,92%)</option>
                <option value="C" {% if kategoria_zbiorcza == 'C' %}selected{% endif %}>Chemia gospodarcza (12,92%)</option>
                <option value="D" {% if kategoria_zbiorcza == 'D' %}selected{% endif %}>AGD zwyk≈Çe (13,53%)</option>
                <option value="E" {% if kategoria_zbiorcza == 'E' %}selected{% endif %}>Elektronika (5,55%)</option>
                <option value="F" {% if kategoria_zbiorcza == 'F' %}selected{% endif %}>Chemia do 60 z≈Ç (18,45% / 9,84%)</option>
                <option value="G" {% if kategoria_zbiorcza == 'G' %}selected{% endif %}>Sklep internetowy</option>
                <option value="H" {% if kategoria_zbiorcza == 'H' %}selected{% endif %}>Inna prowizja</option>
                <option value="I" {% if kategoria_zbiorcza == 'I' %}selected{% endif %}>Strefa okazji (+60% prowizji podstawowej)</option>
            </select>
            
            <label>
                <input type="checkbox" id="czy_smart_zbiorcze" name="czy_smart_zbiorcze" {% if czy_smart_zbiorcze %}checked{% endif %}>
                Czy smart?
            </label>
            
            <label for="koszt_pakowania_zbiorcze">Koszt pakowania na sztukƒô (z≈Ç):</label>
            <input type="text" id="koszt_pakowania_zbiorcze" name="koszt_pakowania_zbiorcze" value="{{ koszt_pakowania_zbiorcze }}">
            
            <br>
            <input type="submit" name="submit_zbiorczy" value="Oblicz mar≈ºe zbiorczo">
        </form>

        {% if error_message %}
        <div class="error-message">
            <strong>B≈ÇƒÖd:</strong> {{ error_message }}
        </div>
        {% endif %}
    </div>

    {% if wyniki_zbiorcze %}
    <div class="parametry-obliczen">
        <h4>Parametry oblicze≈Ñ:</h4>
        <p><strong>Kategoria:</strong> 
            {% if kategoria_zbiorcza == 'A' %}Supermarket (6,15%)
            {% elif kategoria_zbiorcza == 'B' %}Cukier (12,92%)
            {% elif kategoria_zbiorcza == 'C' %}Chemia gospodarcza (12,92%)
            {% elif kategoria_zbiorcza == 'D' %}AGD zwyk≈Çe (13,53%)
            {% elif kategoria_zbiorcza == 'E' %}Elektronika (5,55%)
            {% elif kategoria_zbiorcza == 'F' %}Chemia do 60 z≈Ç (18,45% / 9,84%)
            {% elif kategoria_zbiorcza == 'G' %}Sklep internetowy
            {% elif kategoria_zbiorcza == 'H' %}Inna prowizja
            {% elif kategoria_zbiorcza == 'I' %}Strefa okazji (+60% prowizji podstawowej)
            {% endif %}
        </p>
        <p><strong>Tryb:</strong> {{ 'Smart' if czy_smart_zbiorcze else 'Nie-smart' }}</p>
        <p><strong>Koszt pakowania:</strong> {{ koszt_pakowania_zbiorcze }} z≈Ç/szt</p>
    </div>

    <div class="podsumowanie">
        <div class="stat-box">
            <div class="stat-label">≈ÅƒÖczna mar≈ºa min</div>
            <div class="stat-value">{{ "%.2f"|format(laczna_marza_min) }} z≈Ç</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">≈ÅƒÖczna mar≈ºa max</div>
            <div class="stat-value">{{ "%.2f"|format(laczna_marza_max) }} z≈Ç</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">≈ÅƒÖczna mar≈ºa najgorsza</div>
            <div class="stat-value">{{ "%.2f"|format(laczna_marza_najgorsza) }} z≈Ç</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">≈örednia mar≈ºa/szt</div>
            <div class="stat-value">{{ "%.2f"|format((laczna_marza_min + laczna_marza_max) / 2 / liczba_produktow if liczba_produktow > 0 else 0) }} z≈Ç</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">≈ÅƒÖczny zakup</div>
            <div class="stat-value">{{ "%.2f"|format(laczna_cena_zakupu) }} z≈Ç</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">≈ÅƒÖczna sprzeda≈º</div>
            <div class="stat-value">{{ "%.2f"|format(laczna_cena_sprzedazy) }} z≈Ç</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Liczba produkt√≥w</div>
            <div class="stat-value">{{ liczba_produktow }}</div>
        </div>
    </div>

    <h3>Szczeg√≥≈Çowe wyniki</h3>
    <div class="tabela-container">
        <div class="wynik">
            <table>
                <thead>
                    <tr>
                        <th>LP</th>
                        <th>Nazwa produktu</th>
                        <th>Cena zakupu</th>
                        <th>Cena sprzeda≈ºy</th>
                        <th>Prowizja</th>
                        <th>Dostawa (przedzia≈Ç)</th>
                        <th>Mar≈ºa (przedzia≈Ç)</th>
                        <th>Mar≈ºa najgorsza</th>
                        <th>Mar≈ºa % (przedzia≈Ç)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for wynik in wyniki_zbiorcze %}
                    <tr>
                        <td>{{ wynik.lp if wynik.lp else loop.index }}</td>
                        <td style="text-align: left;">{{ wynik.nazwa }}</td>
                        <td>
                            <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                                  data-value="{{ "%.2f"|format(wynik.cena_zakupu) }}">
                                {{ "%.2f"|format(wynik.cena_zakupu) }} z≈Ç
                            </span>
                        </td>
                        <td>
                            <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                                  data-value="{{ "%.2f"|format(wynik.cena_sprzedazy) }}">
                                {{ "%.2f"|format(wynik.cena_sprzedazy) }} z≈Ç
                            </span>
                        </td>
                        <td>
                            <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                                  data-value="{{ "%.2f"|format(wynik.prowizja) }}" style="color:var(--red-color);">
                                {{ "%.2f"|format(wynik.prowizja) }} z≈Ç
                            </span>
                        </td>
                        <td>
                            {% if wynik.dostawa_min == wynik.dostawa_max %}
                                {{ "%.2f"|format(wynik.dostawa_min) }} z≈Ç
                            {% else %}
                                <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                                      data-value="{{ "%.2f"|format(wynik.dostawa_min) }} - {{ "%.2f"|format(wynik.dostawa_max) }}"
                                      style="color:var(--blue-color);">
                                    {{ "%.2f"|format(wynik.dostawa_min) }} - {{ "%.2f"|format(wynik.dostawa_max) }} z≈Ç
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if wynik.marza_min == wynik.marza_max %}
                                <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                                      data-value="{{ "%.2f"|format(wynik.marza_min) }}" style="color:var(--green-color);">
                                    {{ "%.2f"|format(wynik.marza_min) }} z≈Ç
                                </span>
                            {% else %}
                                <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                                      data-value="{{ "%.2f"|format(wynik.marza_min) }} - {{ "%.2f"|format(wynik.marza_max) }}"
                                      style="color:var(--green-color);">
                                    {{ "%.2f"|format(wynik.marza_min) }} - {{ "%.2f"|format(wynik.marza_max) }} z≈Ç
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                                  data-value="{{ "%.2f"|format(wynik.marza_najgorsza) }}" style="color:var(--orange-color);">
                                {{ "%.2f"|format(wynik.marza_najgorsza) }} z≈Ç
                            </span>
                        </td>
                        <td>
                            {% if wynik.marza_procent_min == wynik.marza_procent_max %}
                                <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                                      data-value="{{ "%.1f"|format(wynik.marza_procent_min) }}" style="color:var(--blue-color);">
                                    {{ "%.1f"|format(wynik.marza_procent_min) }}%
                                </span>
                            {% else %}
                                <span class="kwota-do-kopiowania" onclick="kopiujDoSchowka(this)" 
                                      data-value="{{ "%.1f"|format(wynik.marza_procent_min) }} - {{ "%.1f"|format(wynik.marza_procent_max) }}"
                                      style="color:var(--blue-color);">
                                    {{ "%.1f"|format(wynik.marza_procent_min) }} - {{ "%.1f"|format(wynik.marza_procent_max) }}%
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="przyklad-csv">
        <strong>Legenda:</strong>
        <ul>
            <li><strong>Dostawa (przedzia≈Ç):</strong> minimalny i maksymalny koszt dostawy dla r√≥≈ºnych przewo≈∫nik√≥w</li>
            <li><strong>Mar≈ºa (przedzia≈Ç):</strong> mar≈ºa minimalna (z najdro≈ºszƒÖ dostawƒÖ) i maksymalna (z najta≈ÑszƒÖ dostawƒÖ)</li>
            <li><strong>Mar≈ºa najgorsza:</strong> mar≈ºa w najgorszym przypadku (z dostawƒÖ maksymalnƒÖ)</li>
            <li><strong>Mar≈ºa % (przedzia≈Ç):</strong> procent mar≈ºy minimalnej i maksymalnej w stosunku do ceny zakupu</li>
            <li><span style="color:var(--red-color);">‚óè</span> Koszty (prowizja)</li>
            <li><span style="color:var(--green-color);">‚óè</span> Mar≈ºa dodatnia</li>
            <li><span style="color:var(--orange-color);">‚óè</span> Mar≈ºa w najgorszym przypadku</li>
            <li><span style="color:var(--blue-color);">‚óè</span> Procenty</li>
        </ul>
    </div>
    {% endif %}

    <script>
        function toggleDarkMode() {
            fetch('/toggle_dark_mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.body.classList.toggle('dark-mode', data.dark_mode);
                    document.querySelector('.dark-mode-toggle').textContent = data.icon;
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function kopiujDoSchowka(element) {
            const wartosc = element.getAttribute('data-value');
            const potwierdzenie = document.createElement('span');
            potwierdzenie.className = 'skopiowano-info';
            potwierdzenie.textContent = '‚úì';
            element.appendChild(potwierdzenie);
            potwierdzenie.style.display = 'inline';
            
            setTimeout(() => {
                potwierdzenie.style.display = 'none';
            }, 2000);

            if (navigator.clipboard) {
                navigator.clipboard.writeText(wartosc).catch(() => {
                    kopiujFallback(wartosc);
                });
            } else {
                kopiujFallback(wartosc);
            }
        }

        function kopiujFallback(wartosc) {
            const textarea = document.createElement('textarea');
            textarea.value = wartosc;
            textarea.style.position = 'fixed';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
    </script>
</body>
</html>